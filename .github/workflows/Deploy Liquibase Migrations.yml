name: Liquibase Migrations

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  migrate:
    name: Run Liquibase Update
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) Setup Java (Liquibase needs Java)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3) Setup Liquibase CLI
      - name: Setup Liquibase
        uses: liquibase/setup-liquibase@v2
        with:
          version: '5.0.1'
          edition: 'community'

      # 4) Download JDBC driver + MSAL4J & dependencies
      - name: Download Dependencies
        run: |
          mkdir deps
          # SQL Server JDBC
          curl -L -o deps/mssql-jdbc.jar https://repo1.maven.org/maven2/com/microsoft/sqlserver/mssql-jdbc/13.2.1.jre11/mssql-jdbc-13.2.1.jre11.jar
          # MSAL4J for Azure AD auth
          curl -L -o deps/msal4j.jar https://repo1.maven.org/maven2/com/microsoft/azure/msal4j/1.20.1/msal4j-1.20.1.jar
          # OAuth2 / OIDC support libs
          curl -L -o deps/oauth2-oidc-sdk.jar https://repo1.maven.org/maven2/com/nimbusds/oauth2-oidc-sdk/11.32/oauth2-oidc-sdk-11.32.jar
          curl -L -o deps/nimbus-jose-jwt.jar https://repo1.maven.org/maven2/com/nimbusds/nimbus-jose-jwt/9.42/nimbus-jose-jwt-9.42.jar
          # JSON smart helpers
          curl -L -o deps/json-smart.jar https://repo1.maven.org/maven2/net/minidev/json-smart/2.4.8/json-smart-2.4.8.jar
          curl -L -o deps/accessors-smart.jar https://repo1.maven.org/maven2/net/minidev/accessors-smart/2.4.8/accessors-smart-2.4.8.jar
          # Additional Nimbus content-type
          curl -L -o deps/content-type.jar https://repo1.maven.org/maven2/com/nimbusds/content-type/2.2/content-type-2.2.jar
          # SLF4J API + Simple implementation
          curl -fL -o deps/slf4j-api.jar \
            https://repo1.maven.org/maven2/org/slf4j/slf4j-api/1.7.36/slf4j-api-1.7.36.jar
          curl -fL -o deps/slf4j-simple.jar \
            https://repo1.maven.org/maven2/org/slf4j/slf4j-simple/1.7.36/slf4j-simple-1.7.36.jar
          # Azure identity / SDK json support
          curl -fL -o deps/azure-core.jar https://repo1.maven.org/maven2/com/azure/azure-core/1.38.0/azure-core-1.38.0.jar

          curl -L -o deps/azure-json.jar https://repo1.maven.org/maven2/com/azure/azure-json/1.5.0/azure-json-1.5.0.jar

          curl -fL -o deps/azure-identity.jar https://repo1.maven.org/maven2/com/azure/azure-identity/1.14.1/azure-identity-1.14.1.jar
          # Jackson core
          curl -fL -o deps/jackson-core.jar \
            https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-core/2.15.4/jackson-core-2.15.4.jar
          
          # Jackson annotations
          curl -fL -o deps/jackson-annotations.jar \
            https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-annotations/2.15.4/jackson-annotations-2.15.4.jar
          
          # Jackson databind (THIS is ObjectMapper)
          curl -fL -o deps/jackson-databind.jar \
            https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-databind/2.15.4/jackson-databind-2.15.4.jar
          
                    
      # 5) Run Liquibase update with all jars on the classpath
      - name: Run Liquibase Update
        
        env:
          LIQUIBASE_COMMAND_URL: ${{ secrets.FABRIC_SQL_JDBC_URL }}
          LIQUIBASE_COMMAND_USERNAME: ${{ secrets.FABRIC_SQL_USER }}
          LIQUIBASE_COMMAND_PASSWORD: ${{ secrets.FABRIC_SQL_PASSWORD }}
        run: |
          ls -lah deps # debug step (optional) to check contents
          liquibase \
            --classpath=$(echo deps/*.jar | tr ' ' ':') \
            --changeLogFile=db.changelog-master.yaml \
            update
          
