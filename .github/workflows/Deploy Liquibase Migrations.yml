name: Liquibase Migrations

# Trigger on pushes to main or PRs
on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  migrate:
    name: Run Liquibase Update
    runs-on: ubuntu-latest

    steps:
      # ðŸ‘‡ Checkout your repository
      - name: Checkout code
        uses: actions/checkout@v4

      # ðŸ‘‡ Install Java (GH runners have Java but sometimes explicit setup helps)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ðŸ‘‡ Setup Liquibase (installs CLI)
      - name: Setup Liquibase
        uses: liquibase/setup-liquibase@v2
        with:
          version: '5.0.1'
          edition: 'community'

      # ðŸ‘‡ Install SQL Server JDBC Driver via Liquibase Package Manager
      - name: Install SQL Server JDBC driver
        run: liquibase lpm add mssql --global

      # ðŸ‘‡ Run Liquibase migrations
      - name: Run Liquibase Update
        env:
          LIQUIBASE_COMMAND_URL: ${{ secrets.FABRIC_SQL_JDBC_URL }}
          LIQUIBASE_COMMAND_USERNAME: ${{ secrets.FABRIC_SQL_USER }}
          LIQUIBASE_COMMAND_PASSWORD: ${{ secrets.FABRIC_SQL_PASSWORD }}
        run: |
          liquibase update --changeLogFile=changelog/db.changelog-master.yaml
